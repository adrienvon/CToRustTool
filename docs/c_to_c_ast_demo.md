# C to C AST Demo

## 项目简介

这是一个使用Rust实现的C语言解析器和代码生成器的演示项目。它可以：
1. 解析C代码为抽象语法树（AST）
2. 将AST重新生成为C代码

## 项目结构

```
src/
├── main.rs      - 主程序和示例代码
├── ast.rs       - AST数据结构定义
├── lexer.rs     - 词法分析器（Tokenizer）
├── parser.rs    - 语法分析器（Parser）
└── codegen.rs   - 代码生成器（Code Generator）
```

## 功能特性

### 支持的C语言特性

#### 数据类型
- 基本类型：`int`, `char`, `float`, `double`, `void`
- 指针类型：`int*`, `char**` 等

#### 表达式
- 字面量：整数、浮点数、字符、字符串
- 标识符
- 二元运算符：`+`, `-`, `*`, `/`, `%`, `<`, `>`, `<=`, `>=`, `==`, `!=`, `&&`, `||`
- 一元运算符：`-`, `!`, `*`（解引用）, `&`（取地址）
- 函数调用
- 赋值表达式

#### 语句
- 变量声明（带或不带初始化）
- 返回语句
- 表达式语句
- if-else条件语句
- while循环语句
- 代码块

#### 函数
- 函数定义
- 函数参数
- 返回类型

## 实现细节

### 1. AST数据结构 (ast.rs)

定义了以下主要结构：
- `CType`: 表示C语言类型
- `Expr`: 表示表达式
- `Stmt`: 表示语句
- `Function`: 表示函数
- `Program`: 表示整个程序

### 2. 词法分析器 (lexer.rs)

`Lexer`负责将源代码字符串转换为Token流：
- 识别关键字、标识符、字面量
- 处理运算符和分隔符
- 跳过空白字符
- 支持转义字符

### 3. 语法分析器 (parser.rs)

`Parser`实现递归下降解析：
- 解析类型声明
- 解析表达式（支持运算符优先级）
- 解析语句
- 解析函数定义
- 解析完整程序

运算符优先级（从低到高）：
1. 赋值 `=`
2. 逻辑运算 `&&`, `||`
3. 比较运算 `<`, `>`, `<=`, `>=`, `==`, `!=`
4. 加减运算 `+`, `-`
5. 乘除模运算 `*`, `/`, `%`
6. 一元运算 `-`, `!`, `*`, `&`
7. 主表达式（字面量、标识符、函数调用、括号表达式）

### 4. 代码生成器 (codegen.rs)

`CodeGenerator`将AST转换回C代码：
- 生成格式化的C代码
- 处理缩进
- 生成类型声明
- 生成表达式和语句
- 生成函数定义

## 运行示例

```bash
cargo run
```

程序会运行4个示例：

### 示例1：简单函数
```c
int add(int a, int b) {
    return a + b;
}
```

### 示例2：阶乘函数
```c
int factorial(int n) {
    int result;
    result = 1;
    if (n <= 1) {
        return 1;
    }
    while (n > 1) {
        result = result * n;
        n = n - 1;
    }
    return result;
}
```

### 示例3：主函数与函数调用
```c
int main() {
    int x;
    x = 10;
    int y;
    y = add(x, 5);
    return y;
}
```

### 示例4：复杂表达式
```c
int calculate(int a, int b, int c) {
    int result;
    result = (a + b) * c - a / b;
    if (result > 100) {
        result = 100;
    }
    return result;
}
```

## 输出示例

对于每个示例，程序会输出：
1. 输入的C代码
2. 解析得到的AST结构（Debug格式）
3. 从AST重新生成的C代码

## 未来扩展

当前demo是基础实现，可以扩展的功能包括：

### 语法特性
- [ ] for循环语句
- [ ] switch-case语句
- [ ] do-while循环
- [ ] break和continue语句
- [ ] 数组
- [ ] 结构体
- [ ] 枚举
- [ ] typedef
- [ ] 预处理指令
- [ ] 多文件支持

### 类型系统
- [ ] const/volatile修饰符
- [ ] 函数指针
- [ ] 数组指针
- [ ] 类型转换

### 错误处理
- [ ] 更详细的错误信息
- [ ] 行号和列号跟踪
- [ ] 语法错误恢复

### 优化
- [ ] AST优化
- [ ] 常量折叠
- [ ] 死代码消除

### 转换到Rust
- [ ] C类型到Rust类型映射
- [ ] C语句到Rust语句转换
- [ ] 生成安全的Rust代码
- [ ] 处理指针和引用
- [ ] 生成Rust特有的特性（所有权、生命周期等）

## 技术要点

1. **递归下降解析**：Parser使用递归下降方法实现，结构清晰易懂
2. **运算符优先级**：通过不同的解析函数层次实现运算符优先级
3. **AST设计**：使用Rust的枚举类型优雅地表示不同的语法结构
4. **代码生成**：通过访问者模式遍历AST生成代码

## 总结

这个demo展示了编译器前端的基本实现：
- **词法分析**：将源代码转换为Token流
- **语法分析**：将Token流解析为AST
- **代码生成**：从AST生成目标代码

这为后续实现C到Rust的转换器奠定了基础。下一步可以在此基础上添加类型检查、语义分析，以及最终的Rust代码生成功能。
