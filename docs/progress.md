# Cåˆ°Rustè½¬è¯‘å·¥å…·å¼€å‘è¿›åº¦

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨å¼€å‘ä¸€ä¸ªèƒ½å¤Ÿå°†Cè¯­è¨€ä»£ç è½¬è¯‘ä¸ºRustä»£ç çš„å·¥å…·ï¼Œé‡ç‚¹æ”¯æŒä¸¤ä¸ªæµ‹è¯•é¡¹ç›®ï¼š
- **translate_chibicc**: Cç¼–è¯‘å™¨é¡¹ç›®ï¼ˆ~236KBï¼Œ17ä¸ªæ–‡ä»¶ï¼‰
- **translate_littlefs_fuse**: littlefs FUSEæ–‡ä»¶ç³»ç»Ÿï¼ˆ~291KBï¼Œ13ä¸ªæ–‡ä»¶ï¼Œæ ¸å¿ƒ5593è¡Œï¼‰

## å·²å®Œæˆå·¥ä½œ

### âœ… é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆå·²å®Œæˆï¼‰

#### 1. ASTæ•°æ®ç»“æ„æ‰©å±•
- âœ… åŸºæœ¬ç±»å‹ï¼šint, char, float, double, void
- âœ… æ‰©å±•ç±»å‹ï¼šlong, short, unsigned, signed
- âœ… å¤åˆç±»å‹ï¼šæŒ‡é’ˆã€æ•°ç»„ã€å‡½æ•°æŒ‡é’ˆ
- âœ… ç”¨æˆ·å®šä¹‰ç±»å‹ï¼šstruct, union, enum, typedef
- âœ… ç±»å‹ä¿®é¥°ç¬¦ï¼šconst, volatile

#### 2. è¡¨è¾¾å¼ç³»ç»Ÿ
- âœ… å­—é¢é‡ï¼šæ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ã€å­—ç¬¦ä¸²
- âœ… åŸºæœ¬è¿ç®—ç¬¦ï¼šç®—æœ¯ã€æ¯”è¾ƒã€é€»è¾‘
- âœ… ä½è¿ç®—ç¬¦ï¼š&, |, ^, ~, <<, >>
- âœ… å¤åˆèµ‹å€¼ï¼š+=, -=, *=, /=, %=, &=, |=, ^=, <<=, >>=
- âœ… ä¸€å…ƒè¿ç®—ç¬¦ï¼š-, !, ~, *, &, ++, --
- âœ… å…¶ä»–è¡¨è¾¾å¼ï¼šç±»å‹è½¬æ¢ã€æ•°ç»„è®¿é—®ã€æˆå‘˜è®¿é—®ã€ä¸‰å…ƒè¿ç®—ç¬¦ã€sizeof

#### 3. è¯­å¥ç³»ç»Ÿ
- âœ… å˜é‡å£°æ˜å’Œåˆå§‹åŒ–
- âœ… æ§åˆ¶æµï¼šif-else, while, do-while, for, switch-case
- âœ… è·³è½¬ï¼šbreak, continue, goto, return
- âœ… ä»£ç å—

#### 4. å£°æ˜ç³»ç»Ÿ
- âœ… å‡½æ•°å£°æ˜
- âœ… ç»“æ„ä½“å®šä¹‰
- âœ… è”åˆä½“å®šä¹‰
- âœ… æšä¸¾å®šä¹‰
- âœ… Typedefå®šä¹‰
- âœ… å…¨å±€å˜é‡
- âœ… é¢„å¤„ç†å™¨æŒ‡ä»¤æ¡†æ¶

#### 5. è¯æ³•åˆ†æå™¨
- âœ… å®Œæ•´çš„å…³é”®å­—è¯†åˆ«ï¼ˆ30+ä¸ªï¼‰
- âœ… æ‰€æœ‰è¿ç®—ç¬¦æ”¯æŒï¼ˆ40+ä¸ªï¼‰
- âœ… å­—é¢é‡è§£æï¼ˆæ•´æ•°ã€æµ®ç‚¹ã€å­—ç¬¦ã€å­—ç¬¦ä¸²ï¼‰
- âœ… è½¬ä¹‰å­—ç¬¦å¤„ç†
- âœ… åˆ†éš”ç¬¦è¯†åˆ«

#### 6. ä»£ç ç”Ÿæˆå™¨
- âœ… Cä»£ç ç”Ÿæˆï¼ˆæ‰€æœ‰å·²å®ç°çš„ASTèŠ‚ç‚¹ï¼‰
- âœ… æ ¼å¼åŒ–å’Œç¼©è¿›
- âœ… è¿ç®—ç¬¦ä¼˜å…ˆçº§å¤„ç†

#### 7. DemoéªŒè¯
- âœ… ç®€å•å‡½æ•°è§£æ
- âœ… å¸¦æ¡ä»¶å’Œå¾ªç¯çš„å¤æ‚å‡½æ•°
- âœ… å‡½æ•°è°ƒç”¨
- âœ… å¤æ‚è¡¨è¾¾å¼è¿ç®—
- âœ… ASTå¯è§†åŒ–è¾“å‡º

## å¾…å®Œæˆå·¥ä½œ

### ğŸ”„ é˜¶æ®µ2ï¼šè¯­æ³•åˆ†æå™¨å¢å¼ºï¼ˆè¿›è¡Œä¸­ï¼‰

éœ€è¦å®ç°çš„è§£æåŠŸèƒ½ï¼š
- [ ] ç»“æ„ä½“å®šä¹‰è§£æ
- [ ] è”åˆä½“å®šä¹‰è§£æ
- [ ] æšä¸¾å®šä¹‰è§£æ  
- [ ] Typedefè§£æ
- [ ] æ•°ç»„å£°æ˜è§£æï¼ˆåŒ…æ‹¬å¤šç»´æ•°ç»„ï¼‰
- [ ] å‡½æ•°æŒ‡é’ˆè§£æ
- [ ] æŒ‡é’ˆæ•°ç»„ã€æ•°ç»„æŒ‡é’ˆç­‰å¤æ‚ç±»å‹
- [ ] å…¨å±€å˜é‡å£°æ˜
- [ ] é¢„å¤„ç†å™¨æŒ‡ä»¤ï¼ˆ#include, #define, #ifdefç­‰ï¼‰
- [ ] æ³¨é‡Šå¤„ç†ï¼ˆå•è¡Œ//å’Œå¤šè¡Œ/**/ï¼‰
- [ ] åˆå§‹åŒ–åˆ—è¡¨
- [ ] å¤åˆå­—é¢é‡

### ğŸ“‹ é˜¶æ®µ3ï¼šç±»å‹ç³»ç»Ÿå’Œç¬¦å·è¡¨

- [ ] ç¬¦å·è¡¨å®ç°
  - [ ] ä½œç”¨åŸŸç®¡ç†
  - [ ] å˜é‡æŸ¥æ‰¾
  - [ ] ç±»å‹å®šä¹‰æŸ¥æ‰¾
  - [ ] å‡½æ•°ç­¾åç®¡ç†
  
- [ ] ç±»å‹æ£€æŸ¥
  - [ ] è¡¨è¾¾å¼ç±»å‹æ¨å¯¼
  - [ ] ç±»å‹å…¼å®¹æ€§æ£€æŸ¥
  - [ ] éšå¼ç±»å‹è½¬æ¢
  - [ ] æŒ‡é’ˆç±»å‹æ£€æŸ¥

- [ ] è¯­ä¹‰åˆ†æ
  - [ ] å˜é‡ä½¿ç”¨å‰å£°æ˜æ£€æŸ¥
  - [ ] å‡½æ•°è°ƒç”¨å‚æ•°æ£€æŸ¥
  - [ ] returnè¯­å¥æ£€æŸ¥
  - [ ] break/continueåˆæ³•æ€§æ£€æŸ¥

### ğŸ¯ é˜¶æ®µ4ï¼šRustä»£ç ç”Ÿæˆå™¨

è¿™æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€è¦å®ç°Cåˆ°Rustçš„è½¬æ¢ï¼š

#### 4.1 ç±»å‹æ˜ å°„
```
Cç±»å‹          ->  Rustç±»å‹
int            ->  i32
unsigned int   ->  u32
char           ->  i8
unsigned char  ->  u8
long           ->  i64
float          ->  f32
double         ->  f64
void           ->  ()
T*             ->  *mut T æˆ– &mut T æˆ– *const T æˆ– &T
T[]            ->  Vec<T> æˆ– &[T]
struct S       ->  struct S
enum E         ->  enum E
```

#### 4.2 è¡¨è¾¾å¼è½¬æ¢
- [ ] æŒ‡é’ˆè¿ç®—è½¬æ¢ä¸ºå®‰å…¨æ“ä½œ
- [ ] æ•°ç»„è®¿é—®è½¬æ¢
- [ ] ç±»å‹è½¬æ¢ï¼ˆaså…³é”®å­—ï¼‰
- [ ] NULL -> None æˆ– null_mut()
- [ ] ä½è¿ç®—ä¿æŒä¸å˜

#### 4.3 è¯­å¥è½¬æ¢
- [ ] å˜é‡å£°æ˜æ·»åŠ ç±»å‹æ ‡æ³¨
- [ ] å¾ªç¯è½¬æ¢ï¼ˆforç‰¹æ®Šå¤„ç†ï¼‰
- [ ] switchè½¬æ¢ä¸ºmatch
- [ ] gotoå¤„ç†ï¼ˆå°½é‡æ¶ˆé™¤æˆ–ä½¿ç”¨loop+breakï¼‰

#### 4.4 å‡½æ•°è½¬æ¢
- [ ] å‡½æ•°ç­¾åè½¬æ¢
- [ ] å‚æ•°å¯å˜æ€§æ¨æ–­
- [ ] è¿”å›å€¼å¤„ç†
- [ ] unsafeå—åŒ…è£…

#### 4.5 å†…å­˜ç®¡ç†
- [ ] malloc/free -> Box::new/drop
- [ ] æ‰‹åŠ¨å†…å­˜ç®¡ç†è¯†åˆ«
- [ ] ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼ˆé«˜çº§ï¼‰

### ğŸ› ï¸ é˜¶æ®µ5ï¼šå®Œæ•´è½¬è¯‘å·¥å…·

#### 5.1 æ–‡ä»¶å¤„ç†
- [ ] å¤šæ–‡ä»¶é¡¹ç›®æ”¯æŒ
- [ ] å¤´æ–‡ä»¶è§£æ
- [ ] #includeä¾èµ–åˆ†æ
- [ ] æ¨¡å—åŒ–è¾“å‡º

#### 5.2 é¡¹ç›®è½¬è¯‘
- [ ] è¯»å–Makefileæˆ–CMakeLists.txt
- [ ] ç”ŸæˆCargo.toml
- [ ] ç»„ç»‡æ¨¡å—ç»“æ„
- [ ] ä¾èµ–åº“æ˜ å°„ï¼ˆå¦‚fuse -> fuse-rsï¼‰

#### 5.3 å‘½ä»¤è¡Œå·¥å…·
```bash
c-to-rust-tool [OPTIONS] <INPUT>

OPTIONS:
  -o, --output <DIR>       è¾“å‡ºç›®å½•
  -p, --project            æ•´ä¸ªé¡¹ç›®æ¨¡å¼
  -v, --verbose            è¯¦ç»†è¾“å‡º
  --unsafe-blocks          ç”Ÿæˆunsafeå—
  --no-format              ä¸æ ¼å¼åŒ–è¾“å‡º
```

### ğŸ³ é˜¶æ®µ6ï¼šDockerå’Œè¯„æµ‹ç¯å¢ƒ

#### 6.1 å®Œå–„Dockerfile
```dockerfile
FROM debian:latest

# å®‰è£…ä¾èµ–
RUN apt update && apt install -y \
    build-essential cmake ninja-build \
    bear pkg-config libfuse-dev \
    clang llvm lld curl

# å®‰è£…Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# å¤åˆ¶è½¬è¯‘å·¥å…·
COPY . /app
WORKDIR /app

# æ„å»ºè½¬è¯‘å·¥å…·
RUN cargo build --release
```

#### 6.2 é…ç½®config.toml

**translate_chibiccé…ç½®ï¼š**
```toml
[problem.translate_chibicc]
docker_image = "c-to-rust-tool:latest"
codegen_workdir = "/app"
codegen_command = "/app/target/release/c-to-rust-tool -p /app/translate_chibicc/src -o /tmp/chibicc_rust"
codegen_logfile = "/tmp/chibicc_codegen.log"
codegen_resultdir = "/tmp/chibicc_rust"
build_command = "cargo build --release"
exe = "/tmp/chibicc_rust/target/release/chibicc"
```

**translate_littlefs_fuseé…ç½®ï¼š**
```toml
[problem.translate_littlefs_fuse]
docker_image = "c-to-rust-tool:latest"
codegen_workdir = "/app"
codegen_command = "/app/target/release/c-to-rust-tool -p /app/translate_littlefs_fuse/src -o /tmp/lfs_rust"
codegen_logfile = "/tmp/lfs_codegen.log"
codegen_resultdir = "/tmp/lfs_rust"
build_command = "cargo build --release"
exe = "/tmp/lfs_rust/target/release/lfs"
```

#### 6.3 æµ‹è¯•æµç¨‹
1. ä½¿ç”¨bearç”Ÿæˆcompilation database
2. è§£æCé¡¹ç›®ç»“æ„
3. è½¬è¯‘æ‰€æœ‰Cæ–‡ä»¶åˆ°Rust
4. ç”ŸæˆCargoé¡¹ç›®
5. è¿è¡Œæµ‹è¯•ç”¨ä¾‹éªŒè¯åŠŸèƒ½

## æŠ€æœ¯éš¾ç‚¹

### ğŸ”´ é«˜ä¼˜å…ˆçº§
1. **æŒ‡é’ˆå’Œå¼•ç”¨çš„æ­£ç¡®è½¬æ¢**
   - åŒºåˆ†å¯å˜å’Œä¸å¯å˜å¼•ç”¨
   - åŸå§‹æŒ‡é’ˆ vs å®‰å…¨å¼•ç”¨
   - ç”Ÿå‘½å‘¨æœŸæ¨æ–­

2. **å†…å­˜ç®¡ç†**
   - malloc/freeè¯†åˆ«
   - æ‰€æœ‰æƒè½¬ç§»
   - å€Ÿç”¨æ£€æŸ¥å™¨å‹å¥½çš„ä»£ç 

3. **é¢„å¤„ç†å™¨**
   - å®å±•å¼€
   - æ¡ä»¶ç¼–è¯‘
   - å¸¸é‡å®šä¹‰

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
4. **å¤æ‚ç±»å‹ç³»ç»Ÿ**
   - å‡½æ•°æŒ‡é’ˆè½¬æ¢ä¸ºé—­åŒ…æˆ–fnæŒ‡é’ˆ
   - å¯å˜å‚æ•°å‡½æ•°
   - è”åˆä½“ï¼ˆunsafeï¼‰

5. **ç³»ç»Ÿè°ƒç”¨å’Œå¤–éƒ¨å‡½æ•°**
   - ioctlç­‰ç³»ç»Ÿè°ƒç”¨
   - FFIè¾¹ç•Œå¤„ç†
   - libcå‡½æ•°æ˜ å°„

### ğŸŸ¢ ä½ä¼˜å…ˆçº§
6. **ä»£ç ä¼˜åŒ–**
   - ç”Ÿæˆæƒ¯ç”¨çš„Rustä»£ç 
   - æ¶ˆé™¤ä¸å¿…è¦çš„unsafe
   - ä½¿ç”¨Rustæ ‡å‡†åº“æ›¿ä»£Cåº“

## é¡¹ç›®ç»“æ„

```
CToRustTool/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs           # ä¸»ç¨‹åºï¼ˆå½“å‰æ˜¯demoï¼‰
â”‚   â”œâ”€â”€ ast.rs            # ASTå®šä¹‰ âœ…
â”‚   â”œâ”€â”€ lexer.rs          # è¯æ³•åˆ†æå™¨ âœ…
â”‚   â”œâ”€â”€ parser.rs         # è¯­æ³•åˆ†æå™¨ ğŸ”„
â”‚   â”œâ”€â”€ codegen.rs        # Cä»£ç ç”Ÿæˆå™¨ âœ…
â”‚   â”œâ”€â”€ rust_codegen.rs   # Rustä»£ç ç”Ÿæˆå™¨ âŒ
â”‚   â”œâ”€â”€ type_system.rs    # ç±»å‹ç³»ç»Ÿ âŒ
â”‚   â”œâ”€â”€ symbol_table.rs   # ç¬¦å·è¡¨ âŒ
â”‚   â””â”€â”€ project.rs        # é¡¹ç›®ç®¡ç† âŒ
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ c_to_c_ast_demo.md  # Demoæ–‡æ¡£
â”œâ”€â”€ translate_chibicc/     # æµ‹è¯•é¡¹ç›®1
â”œâ”€â”€ translate_littlefs_fuse/  # æµ‹è¯•é¡¹ç›®2
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ config.toml
â””â”€â”€ README.md
```

## ä¸‹ä¸€æ­¥è®¡åˆ’

### ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨ï¼‰
1. âœ… å®Œå–„ASTæ•°æ®ç»“æ„
2. âœ… æ‰©å±•è¯æ³•åˆ†æå™¨
3. ğŸ”„ å¢å¼ºè¯­æ³•åˆ†æå™¨æ”¯æŒç»“æ„ä½“/æšä¸¾/typedef
4. åˆ›å»ºç¬¦å·è¡¨å’Œç±»å‹ç³»ç»Ÿæ¡†æ¶
5. å¼€å§‹Rustä»£ç ç”Ÿæˆå™¨åŸå‹

### çŸ­æœŸç›®æ ‡ï¼ˆ2å‘¨å†…ï¼‰
1. å®ŒæˆåŸºæœ¬çš„Cåˆ°Rustç±»å‹æ˜ å°„
2. å®ç°ç®€å•å‡½æ•°çš„è½¬è¯‘
3. æ”¯æŒç»“æ„ä½“å®šä¹‰è½¬æ¢
4. æµ‹è¯•ç®€å•Cç¨‹åºçš„è½¬è¯‘

### ä¸­æœŸç›®æ ‡ï¼ˆ1æœˆå†…ï¼‰
1. å®Œæ•´çš„littlefs_fuseé¡¹ç›®è½¬è¯‘
2. é€šè¿‡éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹
3. ä¼˜åŒ–ç”Ÿæˆçš„Rustä»£ç è´¨é‡

### é•¿æœŸç›®æ ‡ï¼ˆæ¯”èµ›å‰ï¼‰
1. ä¸¤ä¸ªé¡¹ç›®å®Œæ•´è½¬è¯‘å¹¶é€šè¿‡æµ‹è¯•
2. ä»£ç è´¨é‡ä¼˜åŒ–
3. æ–‡æ¡£å’Œæ¼”ç¤ºå‡†å¤‡

## è¯„ä¼°æ ‡å‡†

æ ¹æ®æ¯”èµ›è¦æ±‚ï¼Œè¯„åˆ†å°†åŸºäºï¼š
1. **åŠŸèƒ½æ­£ç¡®æ€§**ï¼ˆæœ€é‡è¦ï¼‰ï¼šè½¬è¯‘åçš„ç¨‹åºèƒ½å¦é€šè¿‡æµ‹è¯•ç”¨ä¾‹
2. **ä»£ç è¦†ç›–ç‡**ï¼šèƒ½è½¬è¯‘å¤šå°‘Cä»£ç 
3. **ä»£ç è´¨é‡**ï¼šç”Ÿæˆçš„Rustä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§
4. **æ€§èƒ½**ï¼šè½¬è¯‘åç¨‹åºçš„è¿è¡Œæ€§èƒ½

## é£é™©å’ŒæŒ‘æˆ˜

1. **æ—¶é—´é™åˆ¶**ï¼šé¡¹ç›®è§„æ¨¡è¾ƒå¤§ï¼Œéœ€è¦åˆç†å®‰æ’ä¼˜å…ˆçº§
2. **å¤æ‚æ€§**ï¼šCè¯­è¨€ç‰¹æ€§ä¼—å¤šï¼Œå®Œæ•´æ”¯æŒå¾ˆå›°éš¾
3. **æµ‹è¯•è¦†ç›–**ï¼šéœ€è¦ç¡®ä¿è½¬è¯‘æ­£ç¡®æ€§
4. **unsafeä»£ç **ï¼šå¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œå…¼å®¹æ€§

## æ€»ç»“

å½“å‰å·²ç»å®Œæˆäº†åŸºç¡€æ¡†æ¶çš„æ­å»ºï¼Œå»ºç«‹äº†å®Œæ•´çš„ASTç³»ç»Ÿå’ŒåŸºæœ¬çš„è§£æèƒ½åŠ›ã€‚æ¥ä¸‹æ¥çš„é‡ç‚¹æ˜¯ï¼š
1. å®Œå–„è¯­æ³•åˆ†æå™¨ä»¥æ”¯æŒæ›´å¤æ‚çš„Cè¯­æ³•
2. å®ç°ç±»å‹ç³»ç»Ÿå’Œç¬¦å·è¡¨
3. å¼€å‘Rustä»£ç ç”Ÿæˆå™¨ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
4. æ•´åˆä¸ºå®Œæ•´çš„è½¬è¯‘å·¥å…·

è¿™æ˜¯ä¸€ä¸ªæœ‰æŒ‘æˆ˜ä½†å¯å®ç°çš„ç›®æ ‡ï¼ğŸ’ª
